name: Windows Intel
on:
  workflow_dispatch:
  push:
    branches:
      - master
      - ci/*
  pull_request:
    branches:
      - master
env:
  VCPKG_COMMIT: 2ad004460f5db4d3b66f62f5799ff66c265c4b5d
  MELONDS_GIT_BRANCH: ${{ github.ref }}
  MELONDS_GIT_HASH: ${{ github.sha }}
  MELONDS_BUILD_PROVIDER: GitHub Actions
  MELONDS_VERSION_SUFFIX: " RC"
  VCPKG_MAX_CONCURRENCY: 8
  CMAKE_BUILD_PARALLEL_LEVEL: 8
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Check out sources
      uses: actions/checkout@v3
      
    - name: Setup Intel oneAPI repository
      shell: powershell
      run: |
        # Download and install required components only
        Invoke-WebRequest -Uri https://registrationcenter-download.intel.com/akdlm/irc_nas/19079/w_BaseKit_p_2023.0.0.25940_offline.exe -OutFile BaseKit.exe
        Start-Process -FilePath "BaseKit.exe" -ArgumentList "--silent --eula accept --components=intel.oneapi.win.cpp-compiler" -Wait
        
    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          ${{ github.workspace }}/vcpkg
          ${{ github.workspace }}/vcpkg_installed
        key: ${{ runner.os }}-vcpkg-intel-${{ env.VCPKG_COMMIT }}-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-intel-${{ env.VCPKG_COMMIT }}-
        
    - name: Set up vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
        
    - name: Cache CMake build directory
      uses: actions/cache@v3
      with:
        path: ${{ github.workspace }}/build
        key: ${{ runner.os }}-cmake-intel-build-${{ hashFiles('CMakeLists.txt', 'src/**', 'include/**') }}
        restore-keys: |
          ${{ runner.os }}-cmake-intel-build-
          
    - name: Configure with Intel compiler
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Intel\oneAPI\setvars.bat" intel64
        cmake -B build -DCMAKE_C_COMPILER=icx -DCMAKE_CXX_COMPILER=icx -DCMAKE_BUILD_TYPE=Release -DMELONDS_EMBED_BUILD_INFO=ON
      env:
        NINJA_STATUS: "[%f/%t %o/s %es] "
        
    - name: Build with Intel compiler
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Intel\oneAPI\setvars.bat" intel64
        cmake --build build --config Release --parallel ${{ env.CMAKE_BUILD_PARALLEL_LEVEL }}
      env:
        NINJA_STATUS: "[%f/%t %o/s %es] "
        
    - uses: actions/upload-artifact@v4
      with:
        name: melonDS-windows-intel-x86_64
        path: .\build\melonDS.exe