name: Windows

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - ci/*

env:
  MELONDS_GIT_BRANCH: ${{ github.ref }}
  MELONDS_GIT_HASH: ${{ github.sha }}
  MELONDS_BUILD_PROVIDER: GitHub Actions

  # vcpkg ï¿½oï¿½Cï¿½iï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½
  VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}/vcpkg_binary_cache,readwrite
  # vcpkg ï¿½Ìƒï¿½ï¿½[ï¿½gï¿½fï¿½Bï¿½ï¿½ï¿½Nï¿½gï¿½ï¿½ï¿½ð–¾Žï¿½ï¿½Iï¿½ÉŽwï¿½ï¿½
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg


jobs:
  build:
    runs-on: windows-2025
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Check out sources
        uses: actions/checkout@v3

      # MSYS2 ï¿½Ìƒpï¿½bï¿½Pï¿½[ï¿½Wï¿½Lï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½
      - name: Cache MSYS2 packages
        uses: actions/cache@v3
        with:
          path: |
            C:/msys64/var/cache/pacman/pkg
            C:/msys64/etc/pacman.d/gnupg
          key: ${{ runner.os }}-msys2-${{ hashFiles('**/*.cmake', 'vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-msys2-

      - name: Purge temp msys64 (cache safety)
        shell: pwsh
        run: |
          $p = Join-Path $env:RUNNER_TEMP 'msys64'
          if (Test-Path $p) { Remove-Item -Recurse -Force $p }

      - name: Set up MSYS2 (ucrt64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: ucrt64
          update: false
          path-type: inherit
          pacboy: gcc:p cmake:p ninja:p make:p jq:p

      - name: Show toolchain versions
        run: |
          x86_64-w64-mingw32-g++ --version
          cmake --version
          pkg-config --version || true

      # ï¿½Iï¿½[ï¿½oï¿½[ï¿½ï¿½ï¿½Cï¿½fï¿½Bï¿½ï¿½ï¿½Nï¿½gï¿½ï¿½ï¿½Ìì¬
      - name: Ensure vcpkg overlay directories exist
        run: |
          mkdir -p ./cmake/overlay-ports
          mkdir -p ./cmake/overlay-triplets
          [ -f ./cmake/overlay-ports/.keep ] || echo keep > ./cmake/overlay-ports/.keep
          [ -f ./cmake/overlay-triplets/.keep ] || echo keep > ./cmake/overlay-triplets/.keep

      # vcpkg ï¿½oï¿½Cï¿½iï¿½ï¿½ï¿½Lï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½ï¿½pï¿½tï¿½Hï¿½ï¿½ï¿½_
      - name: Ensure vcpkg binary cache directory exists
        run: |
          mkdir -p "${{ github.workspace }}/vcpkg_binary_cache"

      # vcpkg ï¿½Cï¿½ï¿½ï¿½Xï¿½gï¿½[ï¿½ï¿½ï¿½Ï‚Ýƒpï¿½bï¿½Pï¿½[ï¿½Wï¿½ÌƒLï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½ï¿½iï¿½Ådï¿½vï¿½j
      - name: Cache vcpkg installed packages
        id: vcpkg_installed_cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ github.workspace }}/vcpkg_installed
            ${{ github.workspace }}/vcpkg_binary_cache
          key: ${{ runner.os }}-vcpkg-installed-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-installed-

      # vcpkg ï¿½cï¿½[ï¿½ï¿½ï¿½{ï¿½Ì‚ÌƒLï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½ï¿½iï¿½Ê“rï¿½Ç—ï¿½ï¿½j
      - name: Cache vcpkg tool
        id: vcpkg_tool_cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ github.workspace }}/vcpkg
            !${{ github.workspace }}/vcpkg/buildtrees
            !${{ github.workspace }}/vcpkg/packages
            !${{ github.workspace }}/vcpkg/installed
          key: ${{ runner.os }}-vcpkg-tool-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-tool-

      # vcpkg ï¿½ÌƒZï¿½bï¿½gï¿½Aï¿½bï¿½vï¿½iï¿½Lï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½ï¿½Ì—Lï¿½ï¿½ï¿½ÉŠÖ‚ï¿½ç‚¸ï¿½ï¿½ï¿½sï¿½j
      - name: Set up vcpkg
        run: |
          # vcpkg ï¿½ï¿½ï¿½È‚ï¿½ï¿½ê‡ï¿½ÍƒNï¿½ï¿½ï¿½[ï¿½ï¿½
          if [ ! -d "$VCPKG_ROOT" ]; then
            echo "Cloning vcpkg..."
            git clone https://github.com/Microsoft/vcpkg.git "$VCPKG_ROOT"
          fi
          
          # vcpkg ï¿½Ìƒuï¿½[ï¿½gï¿½Xï¿½gï¿½ï¿½ï¿½bï¿½vï¿½iï¿½Kï¿½vï¿½Èê‡ï¿½Ì‚Ýj
          if [ ! -f "$VCPKG_ROOT/vcpkg.exe" ]; then
            echo "Bootstrapping vcpkg..."
            "$VCPKG_ROOT/bootstrap-vcpkg.bat" -disableMetrics
          fi
          
          # ï¿½oï¿½[ï¿½Wï¿½ï¿½ï¿½ï¿½ï¿½mï¿½F
          "$VCPKG_ROOT/vcpkg.exe" version

      # CMake ï¿½rï¿½ï¿½ï¿½hï¿½fï¿½Bï¿½ï¿½ï¿½Nï¿½gï¿½ï¿½ï¿½ÌƒLï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½
      - name: Cache CMake build directory
        id: cmake_build_cache
        uses: actions/cache@v3
        with:
          path: |
            build/release-mingw-x86_64
            !build/release-mingw-x86_64/*.exe
            !build/release-mingw-x86_64/*.dll
          key: ${{ runner.os }}-cmake-build-${{ hashFiles('CMakeLists.txt', 'cmake/**', 'src/**/*.cpp', 'src/**/*.h') }}
          restore-keys: |
            ${{ runner.os }}-cmake-build-

      # Configureï¿½iï¿½Lï¿½ï¿½ï¿½bï¿½Vï¿½ï¿½ï¿½~ï¿½Xï¿½Ü‚ï¿½ï¿½ï¿½ CMake ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ÏXï¿½ï¿½ï¿½j
      - name: Configure (preset)
        run: |
          # ï¿½rï¿½ï¿½ï¿½hï¿½fï¿½Bï¿½ï¿½ï¿½Nï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ý‚ï¿½ï¿½ACMakeCache.txt ï¿½ï¿½ï¿½ï¿½ï¿½é‚©ï¿½`ï¿½Fï¿½bï¿½N
          if [ ! -f "build/release-mingw-x86_64/CMakeCache.txt" ]; then
            echo "CMakeCache.txt not found, running configure..."
            NEED_CONFIGURE=1
          else
            echo "CMakeCache.txt found, checking if reconfigure is needed..."
            # CMakeLists.txt ï¿½ï¿½ cmake ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½Ì•ÏXï¿½ï¿½ï¿½`ï¿½Fï¿½bï¿½N
            NEED_CONFIGURE=0
          fi
          
          if [ "$NEED_CONFIGURE" = "1" ] || [ "${{ steps.cmake_build_cache.outputs.cache-hit }}" != "true" ]; then
            cmake --preset=release-mingw-x86_64 \
              -DUSE_VCPKG=ON \
              -DMELONDS_EMBED_BUILD_INFO=ON \
              -DCMAKE_SUPPRESS_REGENERATION=ON \
              -DVCPKG_INSTALLED_DIR="${{ github.workspace }}/vcpkg_installed" \
              -DCMAKE_TOOLCHAIN_FILE="${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"
          else
            echo "Using cached CMake configuration"
          fi

      # Build
      - name: Build
        run: |
          cmake --build --preset=release-mingw-x86_64 --parallel
          
          # ï¿½rï¿½ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½mï¿½F
          if [ ! -f "build/release-mingw-x86_64/melonDS.exe" ]; then
            echo "Build failed: melonDS.exe not found"
            exit 1
          fi

      # ï¿½Aï¿½[ï¿½eï¿½Bï¿½tï¿½@ï¿½Nï¿½gï¿½ÌƒAï¿½bï¿½vï¿½ï¿½ï¿½[ï¿½h
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: melonDS-windows-x86_64
          path: build/release-mingw-x86_64/melonDS.exe

      # ï¿½fï¿½oï¿½bï¿½Oï¿½ï¿½ï¿½iï¿½Kï¿½vï¿½É‰ï¿½ï¿½ï¿½ï¿½Äj
      - name: Show cache usage
        if: always()
        run: |
          echo "=== Cache Hit Status ==="
          echo "MSYS2: ${{ steps.msys2_cache.outputs.cache-hit }}"
          echo "vcpkg installed: ${{ steps.vcpkg_installed_cache.outputs.cache-hit }}"
          echo "vcpkg tool: ${{ steps.vcpkg_tool_cache.outputs.cache-hit }}"
          echo "CMake build: ${{ steps.cmake_build_cache.outputs.cache-hit }}"
          
          echo "=== Directory Sizes ==="
          du -sh "${{ github.workspace }}/vcpkg_installed" 2>/dev/null || echo "vcpkg_installed not found"
          du -sh "${{ github.workspace }}/vcpkg" 2>/dev/null || echo "vcpkg not found"
          du -sh "build/release-mingw-x86_64" 2>/dev/null || echo "build directory not found"
